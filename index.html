
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THE BOYS EGEL PLUS 2025 — Banco completo</title>
<style>
  :root{ --bg:#0b1020; --panel:#141a2e; --muted:#9aa3b2; --text:#eaf0ff; --accent:#6aa4ff; --ok:#00d48b; --bad:#ff6b6b; }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#0a0f1c,#0f1730 40%,#0a0f1c); color:var(--text);}
  header{position:sticky; top:0; z-index:9; backdrop-filter:saturate(1.4) blur(8px); background:rgba(10,16,28,.7); border-bottom:1px solid rgba(255,255,255,.06);}
  .wrap{max-width:1200px; margin:0 auto; padding:18px;}
  h1{margin:.2rem 0 .6rem; font-size:clamp(22px,3.6vw,40px);}
  .subtitle{color:var(--muted); margin-top:-6px}
  .board{display:grid; grid-template-columns: minmax(0,1.25fr) minmax(280px,.75fr); gap:18px; margin:18px 0 28px}
  .card{background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .q-stem{font-size:18px; line-height:1.55; margin:6px 0 14px}
  .opt{display:flex; gap:10px; align-items:flex-start; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0f1430;
       cursor:pointer; transition:transform .05s ease, background .15s ease, border-color .2s ease;}
  .opt:hover{transform:translateY(-1px); background:#0f173b}
  .opt input{margin-top:3px}
  .opt.disabled{cursor:not-allowed; opacity:.85}
  .opt.correct{border-color:rgba(0,212,139,.6); background:rgba(0,212,139,.08)}
  .opt.incorrect{border-color:rgba(255,107,107,.6); background:rgba(255,107,107,.08)}
  .explain{white-space:pre-wrap; margin-top:12px; padding:12px; border-left:4px solid var(--accent); background:rgba(106,164,255,.08); border-radius:8px}
  .controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  button{all:unset; background:linear-gradient(180deg,#1d2a55,#1a2446); border:1px solid rgba(255,255,255,.14); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
  button:hover{filter:brightness(1.05)}
  .primary{background:linear-gradient(180deg,#2a54ff,#2649e9); border-color:#3256ff}
  .ghost{background:transparent}
  .muted{color:var(--muted)}
  .pill{display:inline-flex; align-items:center; gap:8px; background:#0b1334; padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.08)}
  .kpi{display:grid; grid-template-columns: 1fr; gap:10px}
  .kpi .item{background:#0e1538; border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px}
  .item h3{margin:4px 0 2px; font-size:26px}
  .bar{height:10px; background:#0c1436; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.08)}
  .bar>i{display:block; height:100%; background:linear-gradient(90deg,#6aa4ff,#00d48b); width:0%}
  .footer{color:var(--muted); font-size:13px; margin-top:6px}
  .small{font-size:12px}
  .q-meta{display:flex; align-items:center; gap:10px; justify-content:space-between; margin:8px 0 4px; flex-wrap:wrap}
  .filters{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  input[type="number"], input[type="text"], textarea{background:#0f1738; border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:10px; padding:8px 10px; width:100%}
  textarea{min-height:90px}
  .index{display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:10px}
  .index button{justify-content:center}
  .badge{font-weight:700; color:#fff; padding:.2rem .5rem; border-radius:6px; font-size:12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14)}
  .tag{font-size:11px; color:var(--muted)}
  .searchRow{display:grid; grid-template-columns: 1fr 120px 120px; gap:10px}
  @media (max-width: 980px){ .board{grid-template-columns: 1fr; } .searchRow{grid-template-columns:1fr} }
</style>
<script id="ANSWER_BLOCK" type="application/json">{}</script>
</head>
<body>
<header>
  <div class="wrap">
    <h1>THE BOYS EGEL PLUS 2025</h1>
    <div class="subtitle">Banco completo — Medicina General · Interactivo con justificación ampliada</div>
  </div>
</header>

<main class="wrap">
  <div class="board">
    <section id="quiz" class="card">
      <div class="q-meta">
        <div class="pill"><strong id="progress">Pregunta 1</strong><span class="muted">/ <span id="total">—</span></span></div>
        <div class="filters" style="flex:1">
          <div class="searchRow" style="flex:1">
            <input id="search" type="text" placeholder="Buscar texto en el enunciado…" />
            <input id="minq" type="number" min="1" value="1" />
            <input id="maxq" type="number" min="1" value="1" />
          </div>
        </div>
      </div>
      <div id="stem" class="q-stem"></div>
      <div id="options" class="list"></div>
      <div id="explain" class="explain"></div>
      <div class="controls">
        <button id="prev" class="ghost">⟵ Anterior</button>
        <button id="next" class="primary">Siguiente ⟶</button>
        <button id="reveal" class="ghost">Mostrar solución</button>
        <button id="mark" class="ghost">Marcar</button>
        <button id="reset" class="ghost">Reiniciar</button>
      </div>
      <div class="footer small" id="cite"></div>
    </section>

    <aside class="card">
      <div class="kpi">
        <div class="item">
          <div class="muted small">Aciertos</div>
          <h3 id="score">0</h3>
          <div class="bar"><i id="bar"></i></div>
          <div class="footer small">Progreso: <span id="done">0</span> respondidas</div>
        </div>
        <div class="item">
          <div class="muted small" style="display:flex; align-items:center; gap:8px">
            <span>Clave del examen</span> <span class="badge">Opcional</span>
          </div>
          <textarea id="keyInput" placeholder="Pega la clave como: 1=C,2=B,3=A … o una por línea: 1 C"></textarea>
          <div class="controls" style="margin-top:8px">
            <button id="loadKey">Cargar clave</button>
            <button id="clearKey" class="ghost">Borrar clave</button>
          </div>
          <div class="footer small">Si no cargas la clave, el modo es de práctica: verás <em>justificación ampliada</em> pero no se calificará la respuesta.</div>
        </div>
        <div class="item">
          <div class="muted small">Marcadas para repasar</div>
          <h3 id="flagCount">0</h3>
          <div class="index" id="flags"></div>
        </div>
      </div>
    </aside>
  </div>

  <section class="card">
    <h2 style="margin:.2rem 0 6px">Cobertura</h2>
    <p class="muted">Este archivo incluye <strong id="coverageCount">—</strong> reactivos extraídos del PDF. Cada reactivo muestra un <em>resumen</em> del caso y <em>pistas clave</em> para guiar tu razonamiento. Cuando cuentes con la clave oficial, cárgala para activar la calificación y revelar el inciso correcto.</p>
    <p class="muted small">Fuente: <em>BANCO COMPLETO GUIA EGEL PLUS, EXAMEN REAL MEDICINA GENERAL 2025.pdf</em>. Cita por pregunta: “PDF p.&lt;número&gt;”.</p>
  </section>

  <section class="card">
    <h2 style="margin:.2rem 0 6px">Bloque único: Clave oficial + Justificaciones extensas</h2>
    <p class="muted">Este bloque JSON vive dentro del archivo y permite cargar la <strong>clave completa</strong> y editar las <strong>justificaciones clínicas</strong> por número de pregunta en <em>un solo lugar</em>.</p>
    <div class="controls" style="margin-bottom:8px">
      <button id="exportBlock">Exportar bloque</button>
      <button id="importBlock" class="ghost">Importar bloque</button>
      <button id="saveToFile" class="ghost">Guardar en archivo</button>
    </div>
    <textarea id="blockEditor" placeholder='Pegue aquí el JSON con el formato {"1":{"answer":"C","justification":"..."},"2":{"answer":"B","justification":"..."}}'></textarea>
    <div class="footer small">Sugerencia: pega la clave oficial una sola vez (por ej. "1=C,2=B,3=A,…") usando el botón Importar; el sistema convertirá los incisos a este bloque.</div>
  </section>

</main>

<script>
// ====== Banco completo desde Python ======
const BANK = [];

// ====== Estado ======
let activeBank = [...BANK];
let current = 0;
let answered = new Map(); // id -> {choice, correct}
let flagged = new Set();

// ====== DOM ======
const totalEl = document.getElementById('total');
const progressEl = document.getElementById('progress');
const stemEl = document.getElementById('stem');
const optionsEl = document.getElementById('options');
const explainEl = document.getElementById('explain');
const scoreEl = document.getElementById('score');
const barEl = document.getElementById('bar');
const doneEl = document.getElementById('done');
const citeEl = document.getElementById('cite');
const searchEl = document.getElementById('search');
const minqEl = document.getElementById('minq');
const maxqEl = document.getElementById('maxq');
const coverageEl = document.getElementById('coverageCount');

const keyInputEl = document.getElementById('keyInput');
const loadKeyBtn = document.getElementById('loadKey');
const clearKeyBtn = document.getElementById('clearKey');

function init(){
  coverageEl.textContent = BANK.length;
  const qnums = activeBank.map(q => q.qnum);
  minqEl.min = Math.min(...qnums); minqEl.max = Math.max(...qnums); minqEl.value = minqEl.min;
  maxqEl.min = minqEl.min; maxqEl.max = minqEl.max; maxqEl.value = maxqEl.max;
  // Ensure IDs
  BANK.forEach((q,i)=> q.id = i+1);
  applyFilters();
}
function applyFilters(){
  const text = (searchEl.value || "").toLowerCase().trim();
  const minQ = parseInt(minqEl.value) || -Infinity;
  const maxQ = parseInt(maxqEl.value) || Infinity;
  activeBank = BANK.filter(q => q.qnum>=minQ && q.qnum<=maxQ && (!text || (q.stem.toLowerCase().includes(text))));
  if(activeBank.length===0){ current=0; }
  else { current = Math.min(current, activeBank.length-1); }
  updateUI();
}
searchEl.addEventListener('input', ()=>{ current=0; applyFilters(); });
minqEl.addEventListener('change', ()=>{ current=0; applyFilters(); });
maxqEl.addEventListener('change', ()=>{ current=0; applyFilters(); });

// ====== Render ======
function updateUI(){
  totalEl.textContent = activeBank.length || 0;
  if(activeBank.length===0){
    stemEl.textContent = "No hay preguntas que coincidan con los filtros.";
    optionsEl.innerHTML = "";
    explainEl.textContent = "";
    citeEl.textContent = "";
    progressEl.textContent = "—";
    return;
  }
  const q = activeBank[current];
  progressEl.textContent = `Pregunta ${q.qnum}`;
  stemEl.textContent = q.stem;
  optionsEl.innerHTML = "";
  q.options.forEach((opt, idx) => { 
    const div = document.createElement('label');
    div.className = "opt";
    const input = document.createElement('input');
    input.type = "radio"; input.name = "opt"; input.value = idx;
    input.addEventListener('change', () => selectOption(idx));
    const span = document.createElement('span'); span.textContent = opt;
    div.appendChild(input); div.appendChild(span);
    optionsEl.appendChild(div);
  });
  explainEl.textContent = q.explanation || "";
  citeEl.textContent = `Fuente: ${q.cite} · Opciones: ${q.options.length}`;

  if(answered.has(q.id)){
    const {choice, correct} = answered.get(q.id);
    [...optionsEl.children].forEach((node, idx)=>{
      node.classList.add('disabled');
      node.querySelector('input').disabled = true;
      node.querySelector('input').checked = (idx===choice);
      if(q.correctIndex!=null){
        if(idx===q.correctIndex) node.classList.add('correct');
        if(idx===choice && !correct) node.classList.add('incorrect');
      }
    });
  } else {
    [...optionsEl.children].forEach(node => {
      node.classList.remove('disabled','correct','incorrect');
      node.querySelector('input').disabled = false;
      node.querySelector('input').checked = false;
    });
  }

  updateScore();
  renderFlags();
}

function selectOption(idx){
  const q = activeBank[current];
  if(answered.has(q.id)) return;
  const hasKey = q.correctIndex!=null;
  const correct = hasKey ? (idx===q.correctIndex) : null;
  answered.set(q.id, {choice: idx, correct});
  [...optionsEl.children].forEach((node, i)=>{
    node.classList.add('disabled');
    node.querySelector('input').disabled = true;
    if(hasKey){ 
      if(i===q.correctIndex) node.classList.add('correct');
      if(i===idx && !correct) node.classList.add('incorrect');
    }
  });
  updateScore();
}

function updateScore(){
  const total = BANK.length;
  const done = answered.size;
  const correct = [...answered.values()].filter(x=>x.correct===true).length;
  scoreEl.textContent = `${correct}/${total}`;
  doneEl.textContent = done;
  const pct = Math.round((correct/Math.max(1,total))*100);
  barEl.style.width = pct + "%";
}

document.getElementById('prev').addEventListener('click', ()=>{ if(activeBank.length){ current = (current-1+activeBank.length)%activeBank.length; updateUI(); } });
document.getElementById('next').addEventListener('click', ()=>{ if(activeBank.length){ current = (current+1)%activeBank.length; updateUI(); } });
document.getElementById('reveal').addEventListener('click', ()=>{
  const q = activeBank[current];
  if(q.correctIndex==null){ alert("No hay clave cargada para esta pregunta. Puedes cargarla en el panel lateral."); return; }
  if(answered.has(q.id)) return;
  answered.set(q.id, {choice: q.correctIndex, correct:true});
  updateUI();
});
document.getElementById('mark').addEventListener('click', ()=>{
  const q = activeBank[current];
  if(flagged.has(q.id)) flagged.delete(q.id); else flagged.add(q.id);
  renderFlags();
});
document.getElementById('reset').addEventListener('click', ()=>{ answered.clear(); flagged.clear(); current = 0; updateUI(); });

function renderFlags(){
  const ids = Array.from(flagged);
  document.getElementById('flagCount').textContent = ids.length;
  const flagsEl = document.getElementById('flags');
  flagsEl.innerHTML = "";
  ids.forEach(id => {
    const q = BANK.find(x=>x.id===id);
    if(!q) return;
    const b = document.createElement('button');
    b.textContent = `Ir a #${q.qnum}`;
    b.className = "pill";
    b.addEventListener('click', ()=>{
      const idx = activeBank.findIndex(x=>x.id===id);
      if(idx>=0){ current = idx; updateUI(); }
      else {
        searchEl.value = ""; minqEl.value = Math.min(...BANK.map(x=>x.qnum)); maxqEl.value = Math.max(...BANK.map(x=>x.qnum));
        applyFilters();
        current = BANK.findIndex(x=>x.id===id); updateUI();
      }
    });
    flagsEl.appendChild(b);
  });
}

// ====== Clave loader ======
function parseKey(raw){
  const map = new Map();
  if(!raw) return map;
  raw.split(/[,
]/).map(s=>s.trim()).filter(Boolean).forEach(piece=>{
    const m = piece.match(/^(\d+)\s*[:=\-\s]\s*([A-Ha-h])$/);
    if(m) map.set(parseInt(m[1],10), m[2].toUpperCase());
  });
  return map;
}
loadKeyBtn.addEventListener('click', ()=>{
  const map = parseKey(keyInputEl.value);
  if(map.size===0){ alert("No se detectó ninguna clave. Formatos válidos: '1=C,2=B,3=A' o una por línea '1 C'."); return; }
  let setCount = 0;
  BANK.forEach(q => {
    if(map.has(q.qnum)){
      const letter = map.get(q.qnum);
      const idx = letter.charCodeAt(0) - 'A'.charCodeAt(0);
      if(idx>=0 && idx<q.options.length){ q.correctIndex = idx; setCount++; }
    }
  });
  alert(`Clave cargada. Reactivos con clave asignada: ${setCount}.`);
  updateUI();
});
clearKeyBtn.addEventListener('click', ()=>{
  BANK.forEach(q => q.correctIndex = null);
  answered.clear();
  alert("Clave eliminada. Modo práctica activado.");
  updateUI();
});

init();
</script>
<script>

// ====== ANSWER_BLOCK integration ======
const ANSWER_BLOCK_TAG = document.getElementById('ANSWER_BLOCK');
let ANSWER_BLOCK = {};
try {
  ANSWER_BLOCK = JSON.parse(ANSWER_BLOCK_TAG?.textContent || "{}");
} catch(e){ ANSWER_BLOCK = {}; }

function applyAnswerBlock(){
  // Apply answers & long justifications
  const byQnum = new Map(Object.entries(ANSWER_BLOCK).map(([k,v])=>[parseInt(k,10), v]));
  BANK.forEach(q => {
    const entry = byQnum.get(q.qnum);
    if(!entry) return;
    if(entry.answer){
      const idx = entry.answer.toUpperCase().charCodeAt(0) - 'A'.charCodeAt(0);
      if(idx>=0 && idx<q.options.length) q.correctIndex = idx;
    }
    if(entry.justification){
      q.explanation = entry.justification;
    }
  });
}
applyAnswerBlock();

// Enhance Import/Export UI
const blockEditor = document.getElementById('blockEditor');
const exportBtn = document.getElementById('exportBlock');
const importBtn = document.getElementById('importBlock');
const saveBtn   = document.getElementById('saveToFile');

if(blockEditor){
  // preload current block
  blockEditor.value = JSON.stringify(ANSWER_BLOCK, null, 2);

  exportBtn?.addEventListener('click', ()=>{
    blockEditor.value = JSON.stringify(ANSWER_BLOCK, null, 2);
    alert("Bloque exportado al editor.");
  });

  importBtn?.addEventListener('click', ()=>{
    // Try if user pasted a short '1=C,2=B' key; convert to block by merging justifications already present
    const raw = blockEditor.value.trim();
    if(!raw){
      alert("Pega el JSON o la clave antes de importar.");
      return;
    }
    let map = new Map();
    // detect short key pattern
    raw.split(/[,\n]/).map(s=>s.trim()).forEach(piece=>{
      const m = piece.match(/^(\d+)\s*[:=\-\s]\s*([A-Ha-h])$/);
      if(m) map.set(parseInt(m[1],10), m[2].toUpperCase());
    });
    if(map.size>0){
      BANK.forEach(q => {
        const ans = map.get(q.qnum);
        const prev = ANSWER_BLOCK[q.qnum] || {};
        ANSWER_BLOCK[q.qnum] = { answer: ans || prev.answer || null, justification: prev.justification || q.explanation || "" };
      });
      blockEditor.value = JSON.stringify(ANSWER_BLOCK, null, 2);
      applyAnswerBlock(); updateUI();
      alert(`Clave importada: ${map.size} reactivos con respuesta.`);
      return;
    }
    // otherwise assume full JSON
    try{
      const obj = JSON.parse(raw);
      ANSWER_BLOCK = obj;
      blockEditor.value = JSON.stringify(ANSWER_BLOCK, null, 2);
      applyAnswerBlock(); updateUI();
      alert("Bloque JSON importado.");
    }catch(e){
      alert("El contenido pegado no es JSON válido ni una clave corta reconocible.");
    }
  });

  saveBtn?.addEventListener('click', ()=>{
    // let user download the updated HTML with embedded block
    const blob = new Blob([document.documentElement.outerHTML], {type: "text/html"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "THE_BOYS_EGEL_PLUS_2025_FULL_with_key.html";
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

</script>
</body>
</html>
